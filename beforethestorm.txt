using PricingLibrary.Computations;
using PricingLibrary.DataClasses;
using PricingLibrary.MarketDataFeed;
using PricingLibrary.TimeHandler;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Portfolio.Library
{
    public class PortfolioComputations
    {
        public static double[] SpotsArray(Dictionary<string, double> PriceList)
        {
            int numberOfShares = PriceList.Count;
            double[] allSpots = new double[numberOfShares];
            for (int i = 0; i < PriceList.Count; i++)
            {
                double spot = PriceList.ElementAt(i).Value;
                allSpots[i] = spot;
            }
            return allSpots;
        }

        public static bool RebalancingTime(DateTime date)
        {
            return date.DayOfWeek == DayOfWeek.Monday;
        }

        public static double riskyAssetsValue(Dictionary<string, double> composition, Dictionary<string, double> spots)
        {
            double sumOfQuantities = 0;
            int counter = 0;
            foreach (var shareId in composition.Keys)
            {
                sumOfQuantities += composition[shareId] * spots[shareId];
                counter++;
            }
            return sumOfQuantities;
        }

        public List<double> PortfolioValues(TestParameters testParameters, List<DataFeed> marketData, Portfolio portfolio)
        {
            //premium computing
            DataFeed initialDataFeed = marketData[0];
            portfolio.Composition = UpdateCompo(testParameters, initialDataFeed);
            List<double> resultingPortfolio = new List<double>() { portfolio.Value };
            foreach (DataFeed dataFeed in marketData.Skip(1))
            {
                portfolio.UpdatingPortfolio(dataFeed);
                //Don't forget the rebalancing ; discarded for now : if Rebalancing()
                Portfolio.Composition = UpdateCompo(testParameters, dataFeed);
            }
            //return portfolio;
        }


        public static Dictionary<string, double> UpdateCompo(TestParameters testParameters, DataFeed dataFeed, Pricer pricer)
        {
            Pricer pricer = new Pricer(testParameters);
            double timeToMaturity = MathDateConverter.ConvertToMathDistance(dataFeed.Date, testParameters.BasketOption.Maturity);
            PricingResults priceResult = pricer.Price(timeToMaturity, SpotsArray(dataFeed.PriceList));
            Dictionary<string, double> resultedUpdate = new Dictionary<string, double>();
            int counter = 0;
            foreach (var shareId in dataFeed.PriceList.Keys)
            {
                resultedUpdate.Add(shareId, priceResult.Deltas[counter]);
                counter++;
            }
            return resultedUpdate;
        }
    }
}